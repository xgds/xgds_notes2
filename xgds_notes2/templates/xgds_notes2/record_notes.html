{% extends 'xgds_notes2/notes_base.html' %}
{% block siteSection %}Record {{settings.XGDS_NOTES_MONIKER}}{% endblock %}

{% load tz %}

{% block content %}
<div id="pre_table">
<p text-align="right">You are {{ user.username }} ({% for key, value in user_session.items %}{{ value }}, {% endfor %}) [<a href="{% url 'xgds_notes_edit_user_session' %}" >change role/location</a>]</p>
<form id="create_note" action="{% url 'xgds_notes_record' %}" method="post">
	<table>
    {{ form.as_table }}
    </table>
    <div id="buttons" >
        <input id="save_note" class="mybutton small" type="submit" value="Save">
    </div>
</form>
<p style="font-style: italic;">Entries logged in the past 12 hours are displayed below.</p>
</div>
<div id="notesDiv">
<div id="messageDiv"></div>
<table id="notesTable" class="display"></table>
</div>
{% endblock content %}

{% block jsInit %}
{% include "xgds_notes2/NoteJSInit.html" %}
{% endblock jsInit %}

{% block scripts %}
<script type="text/javascript">
	    server_time_url = "{% url 'server_time' %}";
	    serverTimezone = "{{TIME_ZONE}}";
</script>
	<script src="{{ EXTERNAL_URL }}jquery/dist/jquery.min.js"></script>
	<script type="text/javascript" src="{{ EXTERNAL_URL }}jquery-ui/jquery-ui.min.js"></script>
	{% include "xgds_core/timeJS.html" %}
	<script type="text/javascript" src="{{ EXTERNAL_URL }}bootstrap/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="{{ EXTERNAL_URL }}typeahead.js/dist/typeahead.bundle.min.js"></script>
	<script type="text/javascript" src="{{ EXTERNAL_URL }}bootstrap-tagsinput/dist/bootstrap-tagsinput.min.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}xgds_notes2/js/note_create_form.js"></script>
	<script type="text/javascript" src="{{ STATIC_URL }}xgds_notes2/js/tags_input.js"></script>
  	<script type="text/javascript" src="{{ EXTERNAL_URL }}datatables/media/js/jquery.dataTables.min.js"></script>
  	<script type="text/javascript" src="{{ EXTERNAL_URL }}datatables-sorting-datetime-moment/js/datetime-moment.js"></script>
	<script type="text/javascript" src="{{ EXTERNAL_URL }}underscore/underscore-min.js"></script>
	<script type="text/javascript" src="{{ EXTERNAL_URL }}klass/klass.min.js"></script>
	
	{% if SSE %}
	<script type="text/javascript" src='{{STATIC_URL}}xgds_notes2/js/liveNotesTable.js'></script>
	{% else %}
	<script type="text/javascript" src='{{STATIC_URL}}xgds_notes2/js/recordedNotesTable.js'></script>
	{% endif %}
	

<script type="text/javascript">
clearForm = function(){
	var tagInput = $("#create_note").find('input#id_tags');
	tagInput.tagsinput('removeAll');
	
	clear_event_time();
	$("#create_note").find('textarea#id_content').val('');
}

$('#save_note').click(function(event) {
	event.preventDefault();
    var theForm = $("#create_note");
	var postData = theForm.serializeArray();
	// update the date to be in utc
	//moment.tz.setDefault(app.getTimeZone());
	//var tzified = moment.tz(postData[2].value, 'MM/DD/YYYY HH:mm', serverTimezone);
	var tzified = getUTCTime(postData[0].value, serverTimezone);
	var theUtc = tzified.utc().format('YYYY/MM/DD HH:mm:ss') + ' UTC';
	postData[0].value = theUtc;
    $.ajax(
    {
        url: "{% url 'xgds_notes_record' %}",
        type: "POST",
        dataType: 'json',
        data: postData,
        success: function(data)
        {
        	clearForm();
        	{% if not SSE %}
        	noteController._theDataTable.fnAddData(data[0]);
        	{% endif %}
        	/* var newdict = [];
        	var n = data[0];
        	//newdict['id'] = n.id;
        	newdict.push(getLocalTimeString(n.event_time, n.event_timezone, 'YYYY-MM-DD HH:mm z'));
        	newdict.push(n.author);
        	newdict.push(n.content);
        	newdict.push(n.tags);
        	
        	noteTable.fnAddData(newdict); */
        },
        error: function(data)
        {
        	console.log("boo");
        }
    });
});

$( document ).ready(function() {
	{% if SSE %}
	{% with filter="" %}
	var thefilter = '{{filter}}';
	noteController = new liveNotes.LiveNotesController({
	           liveNotesStreamURL: "{% url 'xgds_notes_liveNotes_stream' %}"  + thefilter,
	           liveNotesURL: " {% url 'xgds_notes_liveNotes'  %}"  + thefilter,
		       columns: {{ settings.XGDS_NOTES_TABLE_DEFAULT_COLUMNS|safe }}
	       });
	 {% endwith %}
	 {% else %}
	 noteController = new recordedNotes.RecordedNotesController({
		           recordedNotesURL: "{% url 'xgds_notes_notesJson_range' 12 %}",
		           columns: {{ settings.XGDS_NOTES_TABLE_DEFAULT_COLUMNS|safe }},
		           ordering: "desc",
		           divHeight: $( window ).height() - $("#pre_table").height() - 200
		       });
	 {% endif %}
	});


</script>
{% endblock scripts %}
